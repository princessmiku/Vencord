name: Sync upstream

on:
    schedule:
        -   cron: "0 3 * * *"
    workflow_dispatch: { }

permissions:
    contents: write
    pull-requests: write

jobs:
    sync:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            -   name: Checkout main
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0
                    ref: main

            -   name: Configure merge driver for .gitattributes (merge=ours)
                run: |
                    git config merge.ours.driver true

            -   name: Add upstream and fetch
                run: |
                    git remote add upstream https://github.com/Vendicated/Vencord.git || true
                    git fetch upstream --prune

            # WICHTIG: Merge OHNE Commit, damit create-pull-request committen kann
            -   name: Merge upstream into main (no commit)
                run: |
                    git merge --no-commit --no-ff upstream/main

            -   name: Create Pull Request
                uses: peter-evans/create-pull-request@v6
                with:
                    base: main
                    branch: bot/sync-upstream
                    title: "chore: sync with upstream"
                    commit-message: "chore: sync with upstream"
                    body: |
                        Automated sync from upstream (Vendicated/Vencord).

                        Please review these files carefully if changed:
                        - scripts/utils.mjs
                        - src/main/csp/index.ts

                        mag folder is protected via .gitattributes:
                        - src/userplugins/mag/**
                    labels: upstream-sync
